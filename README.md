Apple Books é£æ ¼ Android ç”µå­ä¹¦é˜…è¯»å™¨
æŠ€æœ¯è¯´æ˜æ–‡æ¡£ï¼ˆæ–¹æ¡ˆ Aï¼šè‡ªç ” EPUB æ¸²æŸ“å™¨ + Jetpack Composeï¼‰
ç‰ˆæœ¬ï¼š1.0
æœ€åæ›´æ–°ï¼š2025 å¹´ 11 æœˆ
ç›®æ ‡å¹³å°ï¼šAndroid 8.0+ï¼ˆAPI 26ï¼‰ï¼Œä¸»æ¨ Android 10+ï¼ˆAPI 29ï¼‰åŠä»¥ä¸Š
æ ¸å¿ƒç†å¿µï¼šCompose First Â· Kotlin Native Â· ç°ä»£æ¶æ„ Â· ç”¨æˆ·ä½“éªŒä¼˜å…ˆ

ä¸€ã€æ•´ä½“æ¶æ„æ¦‚è§ˆ

æœ¬é¡¹ç›®é‡‡ç”¨ åˆ†å±‚å•å‘æ•°æ®æµï¼ˆUnidirectional Data Flow, UDFï¼‰æ¶æ„ï¼Œç»“åˆ Jetpack Compose æ„å»º UIï¼Œé€šè¿‡ è‡ªç ” EPUB è§£æä¸æ¸²æŸ“å¼•æ“ å®ç°ç±» Apple Books çš„é˜…è¯»ä½“éªŒã€‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UI Layer â”‚ â† Jetpack Compose (Material 3)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ViewModel Layer â”‚ â† StateFlow<UIState>, UseCase è°ƒç”¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Domain Layer â”‚ â† çº¯ Kotlin ä¸šåŠ¡é€»è¾‘ (UseCases)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Data Layer â”‚ â† Repository + Room + File System
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ‰€æœ‰çŠ¶æ€å˜æ›´ç”±ç”¨æˆ·äº¤äº’æˆ–ç³»ç»Ÿäº‹ä»¶è§¦å‘ï¼Œç» ViewModel å¤„ç†åä»¥ä¸å¯å˜ UIState å½¢å¼æš´éœ²ç»™ Composeï¼Œç¡®ä¿å¯é¢„æµ‹æ€§å’Œå¯æµ‹è¯•æ€§ã€‚

äºŒã€æ ¸å¿ƒæŠ€æœ¯æ ˆï¼ˆ2025 æœ€ä½³å®è·µï¼‰

ç±»åˆ« æŠ€æœ¯é€‰å‹
------------------ --------------------------------------------------------------------------
è¯­è¨€ Kotlin 2.0+
UI æ¡†æ¶ Jetpack Compose 1.7+ï¼ˆå®Œå…¨å–ä»£ View ç³»ç»Ÿï¼‰
ä¸»é¢˜è®¾è®¡ Material 3 + Dynamic Colorï¼ˆä»ä¹¦ç±å°é¢æå–ä¸»é¢˜è‰²ï¼‰
çŠ¶æ€ç®¡ç† StateFlow<UIState> + collectAsStateWithLifecycle()
å¼‚æ­¥å¤„ç† Kotlin Coroutines + Flow
ä¾èµ–æ³¨å…¥ Hilt 2.50+
æ•°æ®æŒä¹…åŒ– Room 2.6+ï¼ˆä¹¦ç±å…ƒæ•°æ®ã€ä¹¦ç­¾ã€é«˜äº®ï¼‰<br>DataStore Protoï¼ˆç”¨æˆ·åå¥½è®¾ç½®ï¼‰
å›¾ç‰‡åŠ è½½ Coil 2.6+ï¼ˆæ”¯æŒ Composeã€å†…å­˜ä¼˜åŒ–ã€è‡ªåŠ¨å›æ”¶ï¼‰
æ–‡ä»¶è®¿é—® Storage Access Framework (SAF) + DocumentFileï¼ˆé€‚é… Scoped Storageï¼‰
å¯¼èˆª Compose Navigationï¼ˆç±»å‹å®‰å…¨ã€æ—  Fragmentï¼‰
EPUB è§£æ è‡ªç ”è§£æå™¨ï¼ˆåŸºäº Kotlin æ ‡å‡†åº“ + XML Pull Parserï¼‰
EPUB æ¸²æŸ“ å®šåˆ¶ WebView + JavaScript Bridge + åŠ¨æ€ CSS æ³¨å…¥
å¤šè®¾å¤‡é€‚é… calculateWindowSizeClass() + DevicePostureï¼ˆæ‰‹æœº/å¹³æ¿/æŠ˜å å±ï¼‰
æ€§èƒ½ä¼˜åŒ– Baseline Profiles + R8 Full Mode + Preload Reader Content

ä¸‰ã€æ ¸å¿ƒåŠŸèƒ½æ¨¡å—è¯´æ˜
1. ä¹¦æ¶ï¼ˆBookshelfï¼‰
åŠŸèƒ½ç‚¹ï¼š
ç½‘æ ¼å±•ç¤ºæœ¬åœ° EPUB ä¹¦ç±å°é¢ï¼ˆ3:4 æ¯”ä¾‹ï¼‰
æ”¯æŒæŒ‰ä¹¦åã€ä½œè€…ã€æœ€è¿‘é˜…è¯»æ’åº
â€œ+â€ æŒ‰é’®å¯¼å…¥æ–°ä¹¦ï¼ˆè°ƒç”¨ SAFï¼‰
é•¿æŒ‰å¼¹å‡ºæ“ä½œèœå•ï¼ˆåˆ é™¤ã€é‡å‘½åã€æŸ¥çœ‹è¯¦æƒ…ï¼‰
ç©ºçŠ¶æ€æç¤º & åŠ è½½éª¨æ¶å±
æŠ€æœ¯å®ç°ï¼š
ä½¿ç”¨ LazyVerticalGrid(columns = GridCells.Adaptive(150.dp))
å°é¢å›¾é€šè¿‡ Coil ä»ç§æœ‰ç›®å½•åŠ è½½ï¼ˆè·¯å¾„ï¼š/files/books/{bookId}/cover.jpgï¼‰
ä¹¦ç±å…ƒæ•°æ®å­˜å‚¨äº Room è¡¨ BookEntity
å¯¼å…¥é€»è¾‘å°è£…åœ¨ ImportEpubUseCaseï¼Œå¤åˆ¶æ–‡ä»¶è‡³ App ç§æœ‰ç›®å½•é¿å…æƒé™é—®é¢˜

kotlin
@Entity(tableName = "books")
data class BookEntity(
@PrimaryKey val id: String,
val title: String,
val author: String,
val filePath: String,
val coverPath: String?,
val lastReadAt: Long,
val progressSpineIndex: Int = 0,
val progressOffset: Float = 0f
)

2. é˜…è¯»å™¨ï¼ˆReaderï¼‰
åŠŸèƒ½ç‚¹ï¼š
å…¨å±æ²‰æµ¸å¼é˜…è¯»ï¼ˆéšè—çŠ¶æ€æ /å¯¼èˆªæ ï¼‰
å·¦å³æ»‘åŠ¨ or ç‚¹å‡»è¾¹ç¼˜ç¿»é¡µ
è‡ªå®šä¹‰å­—ä½“ã€å­—å·ã€è¡Œè·ã€èƒŒæ™¯è‰²ï¼ˆæ—¥é—´/å¤œé—´/æŠ¤çœ¼ï¼‰
ä¹¦ç­¾ã€æ–‡æœ¬é«˜äº®ã€ç¬”è®°
è‡ªåŠ¨ä¿å­˜é˜…è¯»è¿›åº¦
ç›®å½•è·³è½¬ï¼ˆTOCï¼‰
æŠ€æœ¯å®ç°ï¼ˆæ–¹æ¡ˆ A æ ¸å¿ƒï¼‰ï¼š
2.1 EPUB è§£æ
ä½¿ç”¨ ZipInputStream è§£å‹ EPUBï¼ˆæœ¬è´¨æ˜¯ ZIPï¼‰
è§£æ META-INF/container.xml â†’ è·å– content.opf
ä» content.opf æå–ï¼š
<manifest> â†’ æ‰€æœ‰ HTML èµ„æºè·¯å¾„ï¼ˆspineï¼‰
<metadata> â†’ ä¹¦åã€ä½œè€…ã€è¯­è¨€
<guide> / <nav> â†’ ç›®å½•ç»“æ„ï¼ˆNCX æˆ– XHTML Navï¼‰
å°é¢å›¾ä¼˜å…ˆä» <meta name="cover"> æˆ– <item properties="cover-image"> æå–
2.2 æ¸²æŸ“å¼•æ“
ä½¿ç”¨ AndroidView(factory = { WebView(context) }) åµŒå…¥ WebView
å¯ç”¨å¿…è¦è®¾ç½®ï¼š
kotlin
webView.settings.apply {
javaScriptEnabled = true
domStorageEnabled = true
builtInZoomControls = false
displayZoomControls = false
loadWithOverviewMode = true
useWideViewPort = true
}
å…³é”®ï¼šæ³¨å…¥è‡ªå®šä¹‰ CSS
kotlin
private fun injectStyles(webView: WebView) {
val css = """
body {
font-family: '${userPrefs.fontFamily}';
font-size: ${userPrefs.fontSize}rem;
line-height: ${userPrefs.lineHeight};
background-color: ${theme.bgColor};
color: ${theme.textColor};
margin: 0 auto;
max-width: 800px;
padding: 20px;
}
""".trimIndent()
webView.evaluateJavascript("var style = document.createElement('style'); style.innerHTML = $css; document.head.appendChild(style);", null)
}

2.3 Kotlin â†” JavaScript åŒå‘é€šä¿¡
Kotlin â†’ JSï¼šwebView.evaluateJavascript(jsCode, callback)
JS â†’ Kotlinï¼šé€šè¿‡ @JavascriptInterface æ³¨å†Œæ¡¥æ¥å¯¹è±¡

kotlin
class WebAppInterface(private val onProgressUpdate: (Float) -> Unit) {
@JavascriptInterface
fun onScroll(percent: Float) {
// ä¸»çº¿ç¨‹å›è°ƒ
Handler(Looper.getMainLooper()).post { onProgressUpdate(percent) }
}

@JavascriptInterface
fun onSelection(text: String, start: Int, end: Int) {
// è§¦å‘é«˜äº®èœå•
}
}
webView.addJavascriptInterface(WebAppInterface { offset ->
viewModel.updateReadingProgress(offset)
}, "Android")
2.4 ç¿»é¡µé€»è¾‘
æ»‘åŠ¨ç¿»é¡µï¼šä½¿ç”¨ Modifier.pointerInput æ•è·æ‰‹åŠ¿
å·¦æ»‘ â†’ ä¸‹ä¸€ç« ï¼ˆè‹¥å½“å‰ç« æœªç»“æŸï¼Œåˆ™æ»šåŠ¨åˆ°åº•éƒ¨ï¼‰
å³æ»‘ â†’ ä¸Šä¸€ç« 
ç‚¹å‡»ç¿»é¡µï¼šå±å¹•å·¦å³ 20% åŒºåŸŸç‚¹å‡»è§¦å‘

3. ç”¨æˆ·åå¥½ä¸åŒæ­¥ï¼ˆå¯é€‰ï¼‰
ä½¿ç”¨ Proto DataStore å­˜å‚¨ï¼š
protobuf
message UserPreferences {
string font_family = 1;
float font_size = 2;
float line_height = 3;
ThemeMode theme_mode = 4;
enum ThemeMode { DAY = 0; NIGHT = 1; SEPIA = 2; }
}
äº‘åŒæ­¥ï¼ˆæœªæ¥æ‰©å±•ï¼‰ï¼šé€šè¿‡ Firebase Firestore åŒæ­¥ ReadingProgress å’Œ Highlight

å››ã€å…³é”®ä¸šåŠ¡é€»è¾‘æµç¨‹
1. å¯¼å…¥ EPUB æµç¨‹
mermaid
sequenceDiagram
participant User
participant BookshelfScreen
participant ImportEpubUseCase
participant EpubParser
participant BookRepository

User->>BookshelfScreen: ç‚¹å‡»â€œ+â€
BookshelfScreen->>ImportEpubUseCase: launch SAF
ImportEpubUseCase->>ImportEpubUseCase: å¤åˆ¶æ–‡ä»¶åˆ° /files/books/{uuid}/book.epub
ImportEpubUseCase->>EpubParser: parseMetadata(file)
EpubParser-->>ImportEpubUseCase: BookMetadata
ImportEpubUseCase->>BookRepository: insert(BookEntity)
BookRepository-->>BookshelfScreen: æ›´æ–° UIState
2. æ‰“å¼€ä¹¦ç±å¹¶æ¸²æŸ“
mermaid
flowchart TD
A[ç”¨æˆ·ç‚¹å‡»ä¹¦ç±] --> B{æ˜¯å¦é¦–æ¬¡æ‰“å¼€?}
B -- æ˜¯ --> C[è§£å‹ EPUB åˆ°ç¼“å­˜ç›®å½•]
B -- å¦ --> D[ç›´æ¥è¯»å–ç¼“å­˜]
C --> E[è§£æ spine åˆ—è¡¨å’Œ TOC]
D --> E
E --> F[å¯åŠ¨ ReaderScreen]
F --> G[WebView åŠ è½½ spine[progressSpineIndex]]
G --> H[æ³¨å…¥ç”¨æˆ· CSS]
H --> I[æ³¨å†Œ JS Bridge]
I --> J[ç›‘å¬æ»šåŠ¨/é€‰æ‹©äº‹ä»¶]
3. ä¿å­˜é˜…è¯»è¿›åº¦
æ¯ 2 ç§’æˆ–é¡µé¢åˆ‡æ¢æ—¶ï¼Œé€šè¿‡ JS è·å–å½“å‰æ»šåŠ¨ç™¾åˆ†æ¯”
ç»“åˆå½“å‰ spine indexï¼Œå†™å…¥ Room
ä¸‹æ¬¡æ‰“å¼€è‡ªåŠ¨å®šä½åˆ°è¯¥ä½ç½®

äº”ã€å®‰å…¨ä¸å…¼å®¹æ€§è€ƒè™‘
WebView å®‰å…¨ï¼š
ç¦ç”¨ file:// è®¿é—®ï¼ˆä»…åŠ è½½ content:// æˆ–ç§æœ‰ç›®å½•ï¼‰
ä¸å¯ç”¨ setAllowFileAccessFromFileURLs
è¿‡æ»¤ EPUB ä¸­çš„ <script> æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰
Android 10+ æ–‡ä»¶è®¿é—®ï¼š
æ‰€æœ‰ä¹¦ç±æ–‡ä»¶å­˜å‚¨äº context.getExternalFilesDir(null)ï¼Œæ— éœ€è¿è¡Œæ—¶æƒé™
EPUB å…¼å®¹æ€§ï¼š
æ”¯æŒ EPUB 2/3 æ ‡å‡†
å¯¹éæ ‡å‡† EPUB è¿›è¡Œå®¹é”™å¤„ç†ï¼ˆå¦‚ç¼ºå¤± coverï¼‰

å…­ã€æœªæ¥æ‰©å±•æ–¹å‘
âœ… PDF æ”¯æŒï¼šé€šè¿‡ Dynamic Feature Module æŒ‰éœ€ä¸‹è½½
âœ… æ–‡æœ¬è½¬è¯­éŸ³ï¼ˆTTSï¼‰ï¼šé›†æˆ Android TTS API
âœ… è·¨å¹³å°å…±äº«ï¼šä½¿ç”¨ Kotlin Multiplatform å…±äº« EPUB è§£æé€»è¾‘ï¼ˆiOS/macOSï¼‰
âœ… AI ç¬”è®°æ‘˜è¦ï¼šæœ¬åœ° LLM ç”Ÿæˆç« èŠ‚æ‘˜è¦ï¼ˆéœ€è®¾å¤‡æ”¯æŒï¼‰

ä¸ƒã€é™„å½•ï¼šä¾èµ–æ¸…å•ï¼ˆbuild.gradle.kts ç‰‡æ®µï¼‰

kotlin
dependencies {
implementation("androidx.core:core-ktx:1.13.1")
implementation("androidx.lifecycle:lifecycle-runtime-compose:2.8.0")
implementation("androidx.activity:activity-compose:1.9.0")
implementation("androidx.compose.ui:ui:1.7.0")
implementation("androidx.compose.material3:material3")
implementation("androidx.navigation:navigation-compose:2.8.0")
implementation("androidx.hilt:hilt-navigation-compose:1.2.0")
implementation("io.coil-kt:coil-compose:2.6.0")
implementation("androidx.datastore:datastore-preferences:1.1.1")
implementation("androidx.room:room-runtime:2.6.1")
implementation("androidx.room:room-ktx:2.6.1")
ksp("androidx.room:room-compiler:2.6.1")
}

ğŸ“Œ å¤‡æ³¨ï¼šæœ¬æ–¹æ¡ˆå®Œå…¨åŸºäº Android å®˜æ–¹ç°ä»£å¼€å‘èŒƒå¼ï¼Œé¿å…ä½¿ç”¨å·²åºŸå¼ƒ APIï¼Œç¡®ä¿åº”ç”¨åœ¨æœªæ¥ 3-5 å¹´å†…ä¿æŒæŠ€æœ¯å…ˆè¿›æ€§ä¸å¯ç»´æŠ¤æ€§ã€‚

